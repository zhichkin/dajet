## DaJet Script

[Начало](https://github.com/zhichkin/dajet/tree/main/doc/dajet-script/README.md)

### Шаблон простого "вечного" сервиса

При помощи цикла **WHILE** и периодического "засыпания" потока выполнения скрипта можно создавать простые "вечные" сервисы. Рассмотрим, например, небольшой сервис мониторинга очереди исходящих сообщений. Предположим, что у нас имеется информационная база 1С:Предприятие 8, которая обменивается данными с другими информационными системами при помощи регистра сведений "ИсходящиеСообщения". Структура регистра выглядит следующим образом:

**Регистр сведений "ИсходящиеСообщения"**
|**Свойство**|**Назначение**|**Тип данных**|**Описание**|
|------------|--------------|--------------|------------|
|НомерСообщения|Измерение|ЧИСЛО(15,0)|Порядковый номер сообщения|
|ТипСообщения|Ресурс|СТРОКА(1024)|Имя типа сообщения|
|ТелоСообщения|Ресурс|СТРОКА(0)|Тело сообщения<br>Формат: JSON<br>Кодировка: UTF-8|

Создадим два скрипта DaJet Script: корень сервиса и его тело. Корневой скрипт ```monitor-root.djs``` будет определять логику вызова функции мониторинга исходящей очереди сообщений и обработку её результатов. Тело сервисного корневого скрипта будет определяться внешним скриптом ```monitor-body.djs```, который кодирует логику получения данных мониторинга: тип сообщения, количество сообщений и размер данных в байтах. Оба скрипта будут располагаться в корневом каталоге ```services``` программы выполнения.

```SQL
-- ********************
-- * monitor-root.djs *
-- ********************
DECLARE @monitor array
DECLARE @details object

WHILE TRUE -- "Вечный" цикл
   
   PRINT 'Мониторинг очереди исходящих сообщений'

   EXECUTE 'file://services/monitor-body.djs' INTO @monitor

   -- Выводим результат в лог программы
   FOR @details IN @monitor
      PRINT '[' + @details.ТипСообщения + '] ' +
            @details.КоличествоСообщений + ' (' +
            @details.ОбъёмДанныхВБайтах + ')'
   END

   SLEEP 10 -- "Спим" 10 секунд прежде, чем повторить
END
```

```SQL
-- ********************
-- * monitor-body.djs *
-- ********************
DECLARE @statistics array

USE 'mssql://server/database'

   SELECT ТипСообщения
        , КоличествоСообщений = COUNT(*)
        , ОбъёмДанныхВБайтах  = SUM(DATALENGTH(ТелоСообщения))
     INTO @statistics
     FROM РегистрСведений.ИсходящиеСообщения
    GROUP BY ТипСообщения

END

RETURN @statistics
```

```
*************************************************
* Результат выполнения скрипта monitor-root.djs *
*************************************************
[2024-10-20 17:12:12] Мониторинг очереди исходящих сообщений
[2024-10-20 17:12:12] [test 1] 3 (36)
[2024-10-20 17:12:12] [test 2] 2 (24)
[2024-10-20 17:12:12] [test 3] 2 (24)
[2024-10-20 17:12:22] Мониторинг очереди исходящих сообщений
[2024-10-20 17:12:22] [test 1] 3 (36)
[2024-10-20 17:12:22] [test 2] 2 (24)
[2024-10-20 17:12:22] [test 3] 2 (24)
[2024-10-20 17:12:32] Мониторинг очереди исходящих сообщений
[2024-10-20 17:12:32] [test 1] 3 (36)
[2024-10-20 17:12:32] [test 2] 2 (24)
[2024-10-20 17:12:32] [test 3] 2 (24)
```

[Наверх](#шаблон-простого-вечного-сервиса)
