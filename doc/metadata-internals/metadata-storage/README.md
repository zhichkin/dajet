## Схема хранения метаданных 1С:Предприятие 8

Общая схема хранения метаданных конфигурации 1С выглядит следующим образом:

![metadata_storage_1](https://github.com/zhichkin/dajet/blob/main/doc/metadata-internals/images/metadata_storage_1.png)

Чтение метаданных начинается с файла **"root"**, расположенного в таблице **Config** базы данных.

```SQL
-- Microsoft SQL Server
SELECT
    (CASE
     WHEN SUBSTRING(BinaryData, 1, 3) = 0xEFBBBF
     THEN 1
     ELSE 0 END)          AS UTF8,     -- признак сжат файл по алгоритму deflate или нет
    CAST(DataSize AS int) AS DataSize, -- размер файла описания метаданных в байтах
    BinaryData                         -- содержание файла описания метаданных
FROM
    Config
WHERE
    FileName = 'root';
```

Далее читаем файл описания всей конфигурации по полученному из файла "root" идентификатору.
После этого можно прочитать все остальные файлы описания объектов метаданных конфигурации 1С.

Следует обратить внимание на то, что каждый объект метаданных 1С имеет свой идентификатор **GUID**,
который соответствует типу данных 1С "ОбъектМетаданных", а также множество дополнительных **UUID**,
которые соответствуют таким типам данных как (на примере справочника):
- "СправочникСсылка";
- "СправочникОбъект";
- "СправочникВыборка";
- "СправочникМенеджер";
- и т.д. и т.п.

С точки зрения описания метаданных особое значение имеет **UUID** типа данных "Ссылка",
так как именно он используется для описания типов данных пользовательских реквизитов объектов.

Объекты метаданных могут ссылаться друг на друга по **GUID**'ам. Например, на диаграмме выше
обозначено, что подчинённый объект, например, справочник, может ссылаться на свои объекты-владельцы,
что определяет описание типов данных его реквизита **"Владелец"**. То же самое можно сказать про
документы, которые ссылаются на свои регистры движений, что определяет описание типов данных
реквизита **"Регистратор"** для этих регистров. Здесь важно то, что ссылаются они по **GUID**'ам, то есть
по идентификаторам объектов метаданных, а в описании типов нужны **UUID**'ы, указывающие на типы
данных вида "Ссылка". Другими словами для того, чтобы получить эти **UUID**'ы, необходимо
сначала загрузить соответствующие файлы описания метаданных по их **GUID**'ам.

Кроме этого следует иметь ввиду, что предопределённые значения справочников и планов видов характеристик
хранятся отдельно от основного файла объекта метаданных. Для справочников к имени основного файла необходимо
добавить ".1c", а для плана видов характеристик - ".7". То же самое касается состава плана обмена - объекты,
входящие в его состав, хранятся в файле с добавлением ".1" к имени основного файла описания плана обмена.

Для получения имён объектов СУБД, соответствующих объектам метаданных конфигурации 1С,
потребуется обратиться к файлу **"DBNames"** таблицы **Params**. Поиск соответствий в этом файле
выполняется по **GUID** - идентификатору объекта метаданных. Данный файл содержит всю необходимую
для этого информацию. Формирование соответствующих имён объектов СУБД выполняется по правилам 1С,
которые хорошо описаны в документации по платформе 1С:Предприятие 8. Кроме этого, заглянув в СУБД,
можно достаточно несложно вывести эти правила самостоятельно.

Схема хранения описания типов данных реквизитов объектов метаданных является наверное одной из самых сложных:

![metadata_storage_2](https://github.com/zhichkin/dajet/blob/main/doc/metadata-internals/images/metadata_storage_2.png)

Основной файл конфигурации содержит описание:
- общих реквизитов;
- определяемых типов;
- планов видов харакетристик.

В свою очередь каждый из этих объектов имеет своё описание типа. При этом план видов характеристик включает
в себя специальный объект "Характеристика", который определяет описание типа для того реквизита, который
будет его использовать.

Само описание типа реквизита ссылается на типы данных ссылочного типа по их **UUID**'ам типа "Ссылка". При этом
ссылка на тип "Характеристика" и её план видов харакетеристик это не одно и то же - они имеют разные **UUID**'ы.
В первом случае описание типов ссылается на описание типов, определяемое характеристикой, а во втором - на сам
план видов характеристик. Отсюда видно, что ссылка на харакетристику аналогична ссылке на определяемый тип.

Описание типов реквизита играет важнейшую роль в формировании структур хранения данных на уровне СУБД.
Именно оно определяет состав полей таблицы прикладного объекта, используемых для хранения значений реквизита.